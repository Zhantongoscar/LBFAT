# 需求分析文档

## 1. 业务需求
### 1.1 业务背景
电气控制柜测试是产品质量控制的关键环节，需要验证所有接线和功能的正确性。系统通过自动化测试方式，验证控制柜的接线质量和功能完整性。

### 1.2 系统组成
#### 1.2.1 中心测控系统
- MQTT服务器（EMQX）
- 后端服务
- 前端界面
- 数据存储

#### 1.2.2 测试装置（Device）
- 基于ESP32控制器
- 多种类型设备
- 分布式部署
- 具备MQTT通信能力

#### 1.2.3 控制柜系统
- PLC控制器
- I/O模块
- MQTT通信功能

#### 1.2.4 测试单元类型
- DI（数字输入）：用于检测开关量信号
- DO（数字输出）：用于输出开关量信号
- AI（模拟输入）：用于检测模拟量信号
- AO（模拟输出）：用于输出模拟量信号

### 1.3 业务流程
#### 1.3.1 通信架构
- 所有设备通过MQTT协议进行通信
- 中心系统作为消息调度中心
- 测试装置和PLC系统作为执行终端

#### 1.3.2 测试流程
1. 输出信号测试流程：
   - 中心系统向PLC发送输出点控制指令
   - PLC执行输出操��，通过控制柜接线传递信号
   - 测试装置检测到信号并通过MQTT反馈
   - 中心系统验证信号反馈，判断接线正确性

2. 输入信号测试流程：
   - 中心系统控制测试装置产生信号
   - 信号通过控制柜接线传递到PLC
   - PLC读取信号并通过MQTT反馈
   - 中心系统验证信号反馈，判断接线正确性

### 1.4 业务规则
#### 1.4.1 测试规则
- 每个测试点位必须验证信号的正确传递
- 信号测试需要覆盖所有接线点
- 测试结果需要实时反馈
- 异常情况需要明确定位

#### 1.4.2 数据采集要求
- 记录每个测试点的执行情况
- 记录信号传递的时间延迟
- 记录异常发生的具体环节
- 保存完整的测试过程数据

### 1.5 测试规格
#### 1.5.1 信号类型
1. 数字量信号
   - 输入电平：24V DC
   - 输出电平：24V DC
   - 响应时间：<10ms

2. 模拟量信号
   - 电流信号：4-20mA
   - 电压信号：0-10V
   - 采样精度：16位

#### 1.5.2 通信要求
1. MQTT通信
   - QoS级别：1
   - 消息超时：3秒
   - 重试次数：3次

2. 设备响应
   - 命令响应：<100ms
   - 数据上报：<200ms
   - 异常通知：实时

### 1.8 设备配置管理
#### 1.8.1 设备类型管理
1. 设备系列管理
   - 物联网盒子系列（EDB/EBD）
   - 网络块系列（NA/NB/NC等）
   - PLC模块系列（PDI/PDO/PAI/PAO）
   - 支持新系列扩展

2. 设备型号定义
   - 型号基本信息
     * 型号编码
     * 型号名称
     * 设备描述
     * 所属系列
   - 支持型号的增加、修改、停用
   - 支持型号参数配置
   - 支持型号文档管理

#### 1.8.2 Unit配置管理
1. Unit类型配置
   - DI配置（数量、参数）
   - DO配置（数量、参数）
   - AI配置（数量、参数）
   - AO配置（数量、参数）

2. Unit参数定义
   - 序号范围
   - 信号类型
   - 电气参数
   - 通信参数

3. 配置管理功能
   - 支持动态添加Unit配置
   - 支持修改Unit参数
   - 支持Unit配置模板
   - 支持配置复制

#### 1.8.3 设备管理功能
1. 设备注册
   - 设备基本信息录入
   - 型号关联
   - Unit配置确认
   - 通信参数设置

2. 设备维护
   - 设备状态监控
   - 参数调整
   - 固件更新
   - 配置备份

3. 设备分组
   - 按类型分组
   - 按区域分组
   - 按用途分组
   - 自定义分组

#### 1.8.4 配置验证
1. 参数验证
   - Unit配置合法性检查
   - 参数范围检查
   - 配置冲突检查

2. 功能验证
   - Unit功能测试
   - 通信测试
   - 数据采集测试

### 1.9 用户管理系统
#### 1.9.1 用户管理
1. 用户类型
   - 系统管理员：系统配置和维护权
   - 测试管理员：测试任务管理权限
   - 测试人员：执行测试权限
   - 查看人员：查看报告权限

2. 用户功能
   - 用户注册
   - 用户登录
   - 密码修改
   - 个人信息维护

3. 权限管理
   - 角色配置
   - 权限分配
   - 操作授权
   - 访问控制

### 1.10 测试管理系统
#### 1.10.1 Model管理
1. 电柜型号管理
   - 型号信息维护
   - 技术参数配置
   - 测试要求定义
   - 文档管理

2. 真值表管理
   - 测试点位定义
   - 测试参数配置
   - 预期结果设置
   - 版本控制

#### 1.10.2 Order管理
1. 订单信息
   - 订单基本信息
   - 关联电柜型号
   - 生产信息
   - 交付要求

2. 订单状态
   - 待测试
   - 测试中
   - 测试完成
   - 异常处理

#### 1.10.3 测试阶段管理
1. 测试批次
   - 批次创建
   - 测试进度跟踪
   - 结果记录
   - 报告生成

2. 测试状态
   - 未开始
   - 进行中
   - 暂停
   - 完成
   - 异常

3. 测试数据
   - 测试记录保存
   - 历史数据查询
   - 断点续测支持
   - 数据导出功能

#### 1.10.4 报表功能
1. 测试报告
   - 测试概况
   - ���细测试记录
   - 异常情况说明
   - 结果分析

2. 统计分析
   - 测试效率分析
   - 质量趋势分析
   - 异常分布分析
   - 生产效率分析

### 1.11 真值表管理系统
#### 1.11.1 真值表配置界面
1. 基础功能
   - 表格式编辑界面
   - 拖拽式操作
   - 批量编辑功能
   - 实时保存
   - 版本管理

2. 智能辅助
   - IO点位快速选择
     * Device IO点位列表
     * PLC IO点位列表
     * 支持搜索和过滤
     * 支持拖拽添加
   - 测试项模板
     * 常用测试项模板
     * 自定义模板保存
     * 模板快速应用
   - 批量操作
     * 批量复制
     * 批量修改
     * 批量导入/导出

#### 1.11.2 真值表结构
1. 测试项定义
   - 测试项ID
   - 测试项描述
   - 测试类型（输入/输出）
   - 优先级
   - 执行条件

2. 信号配置
   - 输入信号
     * Device点位选择
     * 信号参数设置
     * 触发条件
   - 输出信号
     * PLC点位选择
     * 预期结果
     * 判定条件
   - 时序要求
     * 响应时间
     * 保持时间
     * 超时设置

3. 测试逻辑
   - 前置条件
   - 执行步骤
   - 判定规则
   - 异常处理

#### 1.11.3 辅助功能
1. 配置检查
   - 点位冲突检查
   - 逻辑关系检���
   - 完整性检查
   - 实时验证

2. 导入导出
   - Excel导入导出
   - 模板下载
   - 批量导入
   - 格式转换

3. 版本控制
   - 版本记录
   - 差异对比
   - 版本回退
   - 变更说明

4. 协作功能
   - 多人编辑
   - 修改记录
   - 审核流程
   - 注释功能

#### 1.11.4 测试执行支持
1. 测试项执行
   - 按序执行
   - 条件执行
   - 并行执行
   - 跳过规则

2. 执行监控
   - 实时状态
   - 进度显示
   - 异常提示
   - 中断处理

3. 结果记录
   - 测试数据记录
   - 异常记录
   - 时序记录
   - 日志记录

### 1.12 设备在线管理
#### 1.12.1 设备状态监控
1. 在线状态管理
   - MQTT上线通知处理
   - MQTT遗嘱消息处理
   - 心跳检测
   - 异常断线处理

2. 状态展示
   - 设备在线状态实时显示
   - 在线时长统计
   - 最后通信时间
   - 通信质量监控

3. 设备列表
   - 按类型分类显示
   - 在线/离线过滤
   - 状态变更记录
   - 设备详情查看

#### 1.12.2 通信监控
1. 消息监控
   - 上线消息记录
   - 遗嘱消息记录
   - 通信异常记录
   - 重连记录

2. 统计分析
   - 在线率统计
   - 通信质量分析
   - 异常统计
   - 设备稳定性评估

### 1.13 测试报告管理
#### 1.13.1 报告关联
1. 操作员信息
   - 测试操作员记录
   - 操作员签名
   - 操作时间记录
   - 操作责任追溯

2. 报告权限
   - 报告创建权限
   - 报告修改权限
   - 报告审核权限
   - 报告查看权限

#### 1.13.2 报告内容
1. 基本信息
   - 测试时间
   - 测试操作员
   - 测试环境
   - 测试设备信息

2. 测试记录
   - 测试项目执行记录
   - 异常记录
   - 操作记录
   - 结果分析

3. 报告追溯
   - 报告版本控制
   - 修改历史记录
   - 审核记录
   - 报告归档管理

### 1.14 MQTT通信协议
#### 1.14.1 主题格式规范
1. 主题结构
   - 项目标识：`{project}`
   - 设备类型：`{device_type}`
   - 设备ID：`{device_id}`
   - 单元索引：`{unit_index}`
   - 消息类型：`status/command/response`

2. 主题类型
   - 设备状态：`{project}/{device_type}/{device_id}/status`
   - 控制命令：`{project}/{device_type}/{device_id}/{unit_index}/command`
   - 响应消息：`{project}/{device_type}/{device_id}/{unit_index}/response`

3. 主题示例
   - 状态主题：`lb_test/EDB/4/status`
   - 命令主题：`lb_test/EDB/4/7/command`
   - 响应主题：`lb_test/EDB/4/7/response`

#### 1.14.2 消息格式
1. 状态消息
   - 设备上线状态
   - 设备心跳信息
   - 设备遗嘱消息
   - 设备配置信息

2. 命令消息
   - 控制指令类型
   - 操作参数
   - 时序要求
   - 超时设置

3. 响应消息
   - 执行结果
   - 数据返回
   - 错误信息
   - 时间戳

#### 1.14.3 通信管理
1. 消息质量
   - QoS级别设置
   - 消息持久化
   - 消息重传
   - 超时处理

2. 连接管理
   - 连接认证
   - 会话保持
   - 断线重连
   - 异常处理

3. 消息追踪
   - 消息ID生成
   - 消息记录
   - 通信日志
   - 异常诊断

#### 1.14.4 消息Payload格式
1. JSON基本结构
   - 所有消息采用JSON格式
   - UTF-8编码
   - 必须包含时间戳
   - 必须包含消息ID

2. 状态消息格式

#### 1.14.5 错误码规范
1. 错误码结构
   - 1xxx：通信类错误
     * 1001：连接失败
     * 1002：消息超时
     * 1003：设备离线
     * 1004：消息格式错误
   
   - 2xxx：设备类错误
     * 2001：设备未注册
     * 2002：设备类型错误
     * 2003：单元索引无效
     * 2004：参数范围错误

   - 3xxx：测试类错误
     * 3001：测试点位无效
     * 3002：信号异常
     * 3003：响应超时
     * 3004：判定失败

   - 4xxx：系统类错误
     * 4001：权限不足
     * 4002：资源不足
     * 4003：系统异常
     * 4004：数据库错误

#### 1.14.6 重传机制
1. 重传策略
   - 命令消息重传
     * 初次发送等待：500ms
     * 重传间隔：1s
     * 最大重传次数：3次
     * 超时判定：3s

   - 状态消息重传
     * 心跳间隔：30s
     * 离线判定：90s
     * 自动重连：5次/分钟
     * 重连间隔：递增（1s, 2s, 4s...）

2. 消息确认
   - 发送确认机制
   - 接收确认机制
   - 会话状态维护
   - 消息队列管理

#### 1.14.7 安全机制
1. 通信安全
   - TLS加密传输
   - 证书管理
     * 服务器证书
     * 客户端证书
     * 证书更新机制
   
   - 消息加密
     * 敏感数据加密
     * 密钥管理
     * 加密算法选择

2. 访问控制
   - 设备认证
     * 设备ID验证
     * 接入密钥验证
     * 动态密钥更新
   
   - 操作授权
     * 命令权限控制
     * 操作审计
     * 异常操作检测

3. 数据安全
   - 数据完整性
     * 消息签名
     * 校验和验证
     * 防重放机制
   
   - 数据保护
     * 敏感数据脱敏
     * 数据备份策略
     * 数据销毁机制

4. 安全监控
   - 实时监控
     * 异常连接检测
     * 异常流量检测
     * 异常操作检测
   
   - 安全审计
     * 访问日志
     * 操作日志
     * 安全事件记录
   
   - 应急响应
     * 安全事件分级
     * 响应流程
     * 恢复机制

## 2. 功能需求
### 2.1 测试功能
- 自动化测试流程控制
- 测试指令下发
- 信号采集和验证
- 异常检测和定位
- 测试报告生成

### 2.2 管理功能
- 测试任务管理
- 测试设备管理
- 控制柜型号管理
- 测试方案配置
- 测试数据管理

### 2.3 分析功能
- 实时测试监控
- 测试结果分析
- 质量统计分析
- 异常原因分析

## 3. 非功能需求
### 3.1 性能需求
- 响应时间
- 并发能力
- 数据处理能力

### 3.2 安全需求
- 访问控制
- 数据安全
- 操作审计

### 3.3 可用性需求
- 系统可用性
- 故障恢复
- 备份机制

### 3.4 可维护性需求
- 系统监控
- 问题诊断
- 版本升级

## 4. 需求优先级 